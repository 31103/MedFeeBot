# **MedFeeBot 開発計画**

本ドキュメントは、診療報酬改定通知監視Bot（MedFeeBot）の開発計画を定義するものです。プロジェクト全体を複数のフェーズに分割し、各フェーズの目標、タスク、成果物を明確にします。

**最終目標**:
厚生労働省Webサイト上の診療報酬関連PDF通知を自動検知し、Slackに通知するシステムを構築・運用すること

## **1. 準備フェーズ（所要期間: 1週間）**

### 目標

- 開発環境の構築
- プロジェクト管理体制の確立
- 技術検証（PoC）の実施

### タスク

1. **開発環境セットアップ**
   - Python開発環境構築（venv/pipenv）
   - VSCodeなどIDE設定
   - Git/GitHubの設定
   - プロジェクトリポジトリ作成（MedFeeBot）

2. **プロジェクト管理体制構築**
   - GitHub Projectsでタスク管理を設定
   - コミットメッセージ規約（Conventional Commits）の整備
   - バージョニング戦略（SemVer）の整備

3. **技術検証（PoC）**
   - 対象Webサイト（厚労省）のHTMLパース検証
   - PDFリンク検知ロジックの実験実装
   - Slack API連携の検証

### 成果物

- GitHub リポジトリ（初期構造）
- 開発環境構築手順ドキュメント
- 技術検証結果レポート

## **2. 基本実装フェーズ（所要期間: 2週間）**

### 目標

- コア機能の実装
- ローカルでの動作検証

### タスク

1. **ユーティリティモジュール実装**
   - 設定管理機能
   - ロギング機能

2. **コア機能実装**
   - HTTPクライアント（厚労省サイト取得機能）
   - HTMLパーサー（PDFリンク検知機能）
   - URL管理（既知URLリスト読み書き機能）
   - Slack通知機能

3. **ローカル実行機能実装**
   - ローカル開発環境用のエントリーポイント
   - 設定読み込み処理
   - モックデータ生成

### 成果物

- コア機能実装コード
- README.md（基本的な使用方法）
- requirements.txt

## **3. テストフェーズ（所要期間: 1週間）**

### 目標

- テストコードの実装
- コード品質の向上

### タスク

1. **テスト環境構築**
   - pytestフレームワーク設定
   - テストフィクスチャ作成
   - モック/スタブ実装

2. **単体テスト実装**
   - ユーティリティモジュールのテスト
   - 各コア機能モジュールの単体テスト
   - 型アノテーション検証（mypy）

3. **結合テスト実装**
   - エンドツーエンドのシナリオテスト
   - 異常系テスト（エラーハンドリング検証）

4. **コード品質改善**
   - リファクタリング
   - コメント・ドキュメント文字列の整備
   - コードレビュー

### 成果物

- テストコード一式
- カバレッジレポート
- コード品質レポート

## **4. クラウド実装フェーズ（所要期間: 1週間）**

### 目標

- Google Cloud Functionsへの実装
- GCSを用いた永続化の実装
- **複数URL監視（PDF/会議）への対応**
- Secret Managerによる機密情報管理

### タスク

1. **Cloud Functions対応**
   - エントリーポイント関数の実装 (`main_gcf`)
   - 環境変数設定（基本設定）
   - ローカルエミュレータでの動作確認 (`functions-framework`)
2. **GCS永続化実装**
   - GCS接続機能実装 (`google-cloud-storage`)
   - **複数状態管理実装（PDF用/会議用 GCSファイル）**
     - 既知URLリストのJSON構造設計 (`known_urls.json` - `{url: [pdf_url]}`)
     - 最新会議IDリストのJSON構造設計 (`latest_ids.json` - `{url: meeting_id}`)
     - 読み書き処理の実装とエラーハンドリング
3. **Secret Manager連携**
   - Slack APIトークン管理の実装 (`google-cloud-secret-manager`)
   - シークレット取得処理の実装 (`config.py`)
4. **複数URL監視対応**
   - 設定駆動型アーキテクチャ導入 (`config.py` の `URL_CONFIGS`)
   - メインロジックでのURL別処理分岐 (`main.py`)
   - 各URLタイプに対応するパーサー・ストレージ関数の呼び出し

### 成果物

- Cloud Functions用コード (更新された `src` ディレクトリ全体)
- デプロイ設定ファイル (`requirements.txt` 更新含む)
- GCS接続テスト結果
- **状態ファイル仕様 (`known_urls.json`, `latest_ids.json`)**

## **5. デプロイフェーズ（所要期間: 1週間）**

### 目標

- ステージング環境へのデプロイと検証
- 本番環境へのデプロイ
- CI/CDパイプラインの構築

### タスク

1. **ステージング環境構築**
   - GCP プロジェクト設定（ステージング用）
   - **Secret Managerに必要なシークレットを設定**
   - Cloud Functions デプロイ（ステージング、**複数URL設定 (`TARGET_URLS`,
     `URL_CONFIGS`反映) を含む**）
   - GCS バケット作成・設定
   - テスト用Slackチャンネル設定
   - ステージング環境での動作検証
2. **本番環境構築**
   - GCP プロジェクト設定（本番用）
   - **Secret Managerに必要なシークレットを設定**
   - Cloud Functions デプロイ（本番、**複数URL設定 (`TARGET_URLS`,
     `URL_CONFIGS`反映) を含む**）
   - GCS バケット作成・設定
   - 本番Slackチャンネル設定
3. **CI/CD構築**
   - GitHub Actions設定
   - 自動テスト設定
   - 自動デプロイ設定（ステージング/本番）

### 成果物

- デプロイ済みステージング環境
- デプロイ済み本番環境
- CI/CD設定ファイル (`.github/workflows/`)
- デプロイ手順書
- **設定済み環境変数一覧**

## **6. 運用準備フェーズ（所要期間: 1週間）**

### 目標

- 監視・アラート体制の構築
- 運用手順の整備
- 初期運用データの収集

### タスク

1. **監視設定**
   - Cloud Monitoringアラート設定
   - エラー通知設定
   - ダッシュボード作成

2. **運用手順整備**
   - 障害対応手順書作成
   - バージョンアップ手順書作成
   - 設定変更手順書作成

3. **初期データ収集**
   - 初回実行（既存PDF URL収集）
   - 正常動作確認
   - ログ確認

### 成果物

- 監視ダッシュボード
- アラート設定
- 運用手順書
- 初期データ

## **7. 評価・改善フェーズ（所要期間: 継続的）**

### 目標

- システムの安定稼働の確認
- 改善点の洗い出し
- 追加機能の検討

### タスク

1. **運用評価**
   - 1か月間の運用データ収集
   - パフォーマンス評価
   - 安定性評価

2. **改善計画**
   - 問題点・改善点のリストアップ
   - 優先順位付け
   - バックログ作成

3. **拡張計画**
   - 追加機能の検討
   - ロードマップ作成

### 成果物

- 運用評価レポート
- 改善計画書
- 次期開発ロードマップ

## **タイムライン**

| フェーズ              | 週1 | 週2 | 週3 | 週4 | 週5 | 週6 | 週7 | 週8 |
| --------------------- | --- | --- | --- | --- | --- | --- | --- | --- |
| 1. 準備 (完了)        | ✓   |     |     |     |     |     |     |     |
| 2. 基本実装 (完了)    |     | ✓   | ✓   |     |     |     |     |     |
| 3. テスト (完了)      |     |     |     | ✓   |     |     |     |     |
| 4. クラウド実装(完了) |     |     |     |     | ✓   |     |     |     |
| 5. デプロイ           |     |     |     |     |     | ✓   |     |     |
| 6. 運用準備           |     |     |     |     |     |     | ✓   |     |
| 7. 評価・改善         |     |     |     |     |     |     |     | ✓→  |

## **リスクと対策**

| リスク                               | 影響度 | 発生確率 | 対策                                                                                 |
| ------------------------------------ | ------ | -------- | ------------------------------------------------------------------------------------ |
| 厚労省サイトの構造変更               | 高     | 中       | HTMLパーサーを柔軟に設計し、変更に強い実装を行う。監視と素早い対応体制を整備。       |
| **特定監視対象サイトのHTML構造変更** | **中** | **中**   | **定期的なパーサーの見直し。構造変更時の迅速な修正体制。アドホック実装箇所の特定。** |
| GCS接続障害                          | 中     | 低       | リトライ処理の実装。障害時の代替動作（全PDFを通知）の検討。                          |
| Slack API仕様変更                    | 中     | 低       | 依存ライブラリの定期更新。変更時の素早い対応体制を整備。                             |
| Google Cloud料金の増加               | 低     | 低       | 実行頻度の最適化。コスト監視の実施。                                                 |

## **成功基準**

本プロジェクトは以下の条件を満たした場合に成功と判断する：

1. 厚生労働省サイトの新規PDF**および中医協の新規会議開催**を漏れなく検知できること
2. 新規PDF**または新規会議開催が検知された場合**、15分以内にSlack通知が届くこと
3. 1か月間の連続運用で障害発生がないこと
4. 月間の運用コストが予算内（例：5,000円以内）に収まること
5. 通知を受けた事業部門が「情報収集が効率化された」と評価すること
